<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klasifikasi Fase Kristal Cair Nematik</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071126 0%, #071c2b 100%);color:#e6eef6}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    .header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .title{font-size:20px;font-weight:600}
    .layout{display:grid;grid-template-columns:280px 1fr 260px;gap:18px}
    .panel{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;min-height:360px}

    /* Left: prediction */
    .pred-title{font-size:14px;color:var(--muted);margin-bottom:8px}
    .pred-list{display:flex;flex-direction:column;gap:12px}
    .pred-item{display:flex;align-items:center;justify-content:space-between}
    .bar{height:10px;background:rgba(255,255,255,0.07);border-radius:999px;overflow:hidden;flex:1;margin-left:12px;margin-right:12px}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#8b5cf6);border-radius:999px}
    .badge{padding:6px 10px;border-radius:999px;font-weight:600}
    .badge.normal{background:rgba(6,182,212,0.12);color:var(--accent);border:1px solid rgba(6,182,212,0.12)}
    .badge.anomaly{background:rgba(139,92,246,0.08);color:#b794f4;border:1px solid rgba(139,92,246,0.06)}

    /* Center: image display */
    .image-wrap{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
    .preview{width:520px;max-width:100%;height:360px;background:linear-gradient(180deg,#071c2b, #041022);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px dashed rgba(255,255,255,0.04)}
    .preview img{max-width:100%;max-height:100%;object-fit:contain}
    .meta{font-size:13px;color:var(--muted)}

    /* Right: controls */
    .controls{display:flex;flex-direction:column;gap:12px}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#022;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .file-input{display:none}

    /* footer */
    .note{font-size:13px;color:var(--muted);margin-top:10px}

    @media(max-width:920px){.layout{grid-template-columns:1fr;}
      .panel{min-height:260px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Klasifikasi Fase Kristal Cair — Nematik</div>
      <div style="margin-left:auto;color:var(--muted)">Demo: upload gambar mikroskop</div>
    </div>

    <div class="layout">
      <!-- LEFT: Prediction results -->
      <aside class="panel" id="predPanel">
        <div class="pred-title">Hasil Prediksi</div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div id="overallBadge" class="badge normal">Belum ada</div>
          <div class="meta" id="confidenceText">—</div>
        </div>

        <div class="pred-list" id="predList">
          <!-- prediction items inserted here -->
        </div>

        <div class="note">Model: <strong id="modelName">(gunakan API /predict)</strong></div>
        <div class="note">Format respons yang diharapkan: JSON dengan field <code>predictions</code> array. Lihat petunjuk di bawah.</div>
      </aside>

      <!-- CENTER: Image preview -->
      <main class="panel image-wrap">
        <div class="preview" id="preview">
          <div style="text-align:center;color:var(--muted);padding:12px">Belum ada gambar. <br> Klik tombol <em>Upload</em> di kanan.</div>
        </div>
        <div class="meta" id="imgInfo">Ukuran: — • Tipe: —</div>

        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn btn-ghost" id="btnPredict">Predict (API)</button>
          <button class="btn btn-ghost" id="btnDummy">Predict (Demo)</button>
          <button class="btn btn-ghost" id="btnClear">Clear</button>
        </div>
      </main>

      <!-- RIGHT: Upload controls -->
      <aside class="panel controls">
        <label for="file" class="btn btn-primary" style="text-align:center;display:inline-block">Upload Gambar</label>
        <input id="file" class="file-input" type="file" accept="image/*" />

        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" id="btnRotate">Rotate 90°</button>
          <button class="btn btn-ghost" id="btnGrayscale">To Grayscale (preview)</button>
        </div>

        <div style="margin-top:6px">
          <label style="font-size:13px;color:var(--muted)">Endpoint API (optional)</label>
          <input id="apiUrl" type="text" placeholder="http://localhost:5000/predict" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
        </div>

        <div style="margin-top:auto">
          <div class="note">Petunjuk singkat:</div>
          <ul style="color:var(--muted);font-size:13px;padding-left:18px">
            <li>Upload gambar mikroskop (.png/.jpg)</li>
            <li>Klik <em>Predict (API)</em> untuk mengirim gambar ke server</li>
            <li>Atau klik <em>Predict (Demo)</em> untuk demo offline</li>
          </ul>
        </div>
      </aside>
    </div>

    <div style="margin-top:18px;color:var(--muted);font-size:13px">
      API spec: POST /predict — form-data field <code>image</code>. Response example: <code>{"predictions":[{"label":"normal","score":0.92},{"label":"anomaly","score":0.08}],"pred":"normal"}</code>
    </div>
  </div>

  <script>
    // Helper: create prediction item
    function makePredItem(label, score){
      const el = document.createElement('div');
      el.className = 'pred-item';
      const name = document.createElement('div'); name.textContent = label;
      const barWrap = document.createElement('div'); barWrap.className='bar';
      const bar = document.createElement('i'); bar.style.width = (score*100)+'%';
      barWrap.appendChild(bar);
      const scoreText = document.createElement('div'); scoreText.textContent = (score*100).toFixed(1)+'%';
      el.appendChild(name); el.appendChild(barWrap); el.appendChild(scoreText);
      return el;
    }

    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');
    const imgInfo = document.getElementById('imgInfo');
    const predList = document.getElementById('predList');
    const overallBadge = document.getElementById('overallBadge');
    const confidenceText = document.getElementById('confidenceText');
    const apiUrlInput = document.getElementById('apiUrl');

    let currentImage = null; // Image element
    let currentImageBlob = null;

    function clearPreview(){
      preview.innerHTML = '<div style="text-align:center;color:var(--muted);padding:12px">Belum ada gambar. <br> Klik tombol <em>Upload</em> di kanan.</div>';
      imgInfo.textContent = 'Ukuran: — • Tipe: —';
      predList.innerHTML = '';
      overallBadge.textContent = 'Belum ada'; overallBadge.className='badge normal';
      confidenceText.textContent = '—';
      currentImage = null; currentImageBlob = null;
    }

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return; currentImageBlob = f;
      const url = URL.createObjectURL(f);
      preview.innerHTML = '';
      const img = document.createElement('img'); img.src = url; img.alt='uploaded';
      preview.appendChild(img);
      currentImage = img;
      img.onload = ()=>{
        imgInfo.textContent = `Ukuran: ${img.naturalWidth}×${img.naturalHeight} • Tipe: ${f.type} • ${Math.round(f.size/1024)} KB`;
      }
      predList.innerHTML = '';
      overallBadge.textContent = 'Siap'; overallBadge.className='badge normal';
      confidenceText.textContent = 'Menunggu prediksi';
    });

    document.getElementById('btnClear').addEventListener('click', clearPreview);

    // Simple demo predictor: gunakan brightness average untuk memutuskan
    function demoPredictFromImage(img){
      // draw to temp canvas
      const canvas = document.createElement('canvas');
      const w = Math.min(256, img.naturalWidth);
      const h = Math.min(256, img.naturalHeight);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const data = ctx.getImageData(0,0,w,h).data;
      let sum = 0; for(let i=0;i<data.length;i+=4){ sum += (data[i]+data[i+1]+data[i+2])/3; }
      const avg = sum / (data.length/4); // 0..255
      // mapping: brighter images -> more likely normal (this is arbitrary demo logic)
      const pNormal = Math.max(0, Math.min(1, (avg - 60)/120));
      return [{label:'normal', score:pNormal},{label:'anomaly', score:1-pNormal}];
    }

    document.getElementById('btnDummy').addEventListener('click', ()=>{
      if(!currentImage){ alert('Upload gambar dulu.'); return; }
      const preds = demoPredictFromImage(currentImage);
      renderPredictions(preds);
    });

    document.getElementById('btnPredict').addEventListener('click', async ()=>{
      if(!currentImageBlob){ alert('Upload gambar dulu.'); return; }
      const apiUrl = apiUrlInput.value.trim();
      if(!apiUrl){ alert('Masukkan API URL pada kolom di kanan (misal http://localhost:5000/predict)'); return; }
      try{
        overallBadge.textContent = 'Memprediksi...'; overallBadge.className='badge normal';
        confidenceText.textContent = '';
        const fd = new FormData(); fd.append('image', currentImageBlob);
        const res = await fetch(apiUrl, {method:'POST', body:fd});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        // expected shape: {predictions:[{label,score},...], pred: 'normal'}
        if(!j.predictions) throw new Error('Respons tidak sesuai');
        renderPredictions(j.predictions);
      }catch(err){
        alert('Gagal melakukan panggilan API: '+err.message);
        overallBadge.textContent = 'Error'; overallBadge.className='badge anomaly';
      }
    });

    function renderPredictions(predictions){
      predList.innerHTML = '';
      // sort by score desc
      predictions.sort((a,b)=>b.score-a.score);
      predictions.forEach(p=>{
        predList.appendChild(makePredItem(p.label, p.score));
      });
      const top = predictions[0];
      overallBadge.textContent = (top.label || '—');
      overallBadge.className = 'badge '+(top.label.toLowerCase().includes('anom')? 'anomaly' : 'normal');
      confidenceText.textContent = 'Confidence: '+(top.score*100).toFixed(2)+'%';
    }

    // small image ops
    document.getElementById('btnRotate').addEventListener('click', ()=>{
      if(!currentImage) return alert('Upload gambar dulu.');
      // rotate the image in canvas and replace preview
      const img = currentImage;
      const canvas = document.createElement('canvas');
      const w = img.naturalWidth; const h = img.naturalHeight;
      canvas.width = h; canvas.height = w; // swap
      const ctx = canvas.getContext('2d');
      ctx.translate(h/2, w/2); ctx.rotate(Math.PI/2); ctx.drawImage(img, -w/2, -h/2, w, h);
      canvas.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        preview.innerHTML='';
        const newImg = document.createElement('img'); newImg.src = url; preview.appendChild(newImg);
        currentImage = newImg; currentImageBlob = blob;
        newImg.onload = ()=>{ imgInfo.textContent = `Ukuran: ${newImg.naturalWidth}×${newImg.naturalHeight} • Tipe: ${blob.type} • ${Math.round(blob.size/1024)} KB`; }
      }, 'image/png');
    });

    document.getElementById('btnGrayscale').addEventListener('click', ()=>{
      if(!currentImage) return alert('Upload gambar dulu.');
      const img = currentImage;
      const canvas = document.createElement('canvas');
      const w = img.naturalWidth; const h = img.naturalHeight;
      const max = 1200; const scale = Math.min(1, max/Math.max(w,h));
      canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const id = ctx.getImageData(0,0,canvas.width,canvas.height);
      for(let i=0;i<id.data.length;i+=4){
        const v = Math.round((id.data[i]+id.data[i+1]+id.data[i+2])/3);
        id.data[i]=id.data[i+1]=id.data[i+2]=v;
      }
      ctx.putImageData(id,0,0);
      canvas.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        preview.innerHTML=''; const newImg = document.createElement('img'); newImg.src = url; preview.appendChild(newImg);
        currentImage = newImg; currentImageBlob = blob; newImg.onload = ()=>{ imgInfo.textContent = `Ukuran: ${newImg.naturalWidth}×${newImg.naturalHeight} • Tipe: ${blob.type} • ${Math.round(blob.size/1024)} KB`; }
      }, 'image/png');
    });

    // initialize
    clearPreview();
  </script>
</body>
</html>